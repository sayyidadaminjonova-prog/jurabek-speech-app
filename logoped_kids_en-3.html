<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title>Jurabek ‚Äî Speech Game üåà</title>

  <!-- PWA: iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Speech Game" />
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' rx='40' fill='%23FF9A3C'/><text y='120' x='90' font-size='100' text-anchor='middle'>üé§</text></svg>" />

  <!-- PWA: Android / Samsung -->
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#FF9A3C" />
  <meta name="application-name" content="Speech Game" />
  <meta name="description" content="Fun speech therapy game for kids!" />

  <!-- Web App Manifest injected by JS below -->

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #FFF8F0;
      --bg2: #FFF3E0;
      --text: #3D2C1E;
      --muted: #8B6E5A;
      --white: #FFFFFF;

      --red:    #FF6B6B;
      --orange: #FF9A3C;
      --yellow: #FFD93D;
      --green:  #6BCB77;
      --teal:   #4ECDC4;
      --blue:   #4D96FF;
      --purple: #C77DFF;
      --pink:   #FF85A1;

      --page-home:    #FFF3E0;
      --page-words:   #E8F5FF;
      --page-sent:    #F0FFF4;
      --page-task:    #FFF8E1;
      --page-reward:  #FBE8FF;
      --page-parent:  #E8FFF4;

      font-family: 'Nunito', sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

    html { height: -webkit-fill-available; }

    body {
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      min-height: -webkit-fill-available;
      overflow-x: hidden;
      -webkit-text-size-adjust: 100%;
      overscroll-behavior: none;
    }

    /* ============ NAV TABS ============ */
    .nav-bar {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: var(--white);
      border-top: 3px solid rgba(0,0,0,.08);
      display: flex;
      z-index: 100;
      box-shadow: 0 -4px 20px rgba(0,0,0,.1);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }

    .nav-tab {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 10px 4px;
      cursor: pointer;
      border: none;
      background: transparent;
      font-family: 'Nunito', sans-serif;
      font-size: 10px;
      font-weight: 800;
      color: #BBB;
      gap: 2px;
      transition: .2s;
      -webkit-appearance: none;
      min-height: 56px;
    }

    .nav-tab .nav-icon { font-size: 24px; transition: transform .2s; }
    .nav-tab.active { color: var(--text); }
    .nav-tab.active .nav-icon { transform: scale(1.2); }
    .nav-tab:nth-child(1).active { color: var(--orange); }
    .nav-tab:nth-child(2).active { color: var(--blue); }
    .nav-tab:nth-child(3).active { color: var(--green); }
    .nav-tab:nth-child(4).active { color: var(--yellow); }
    .nav-tab:nth-child(5).active { color: var(--purple); }
    .nav-tab:nth-child(6).active { color: var(--pink); }

    /* ============ PAGES ============ */
    .page {
      display: none;
      min-height: 100vh;
      padding: 20px 16px 110px;
      padding-top: calc(20px + env(safe-area-inset-top));
      padding-left: calc(16px + env(safe-area-inset-left));
      padding-right: calc(16px + env(safe-area-inset-right));
      padding-bottom: calc(110px + env(safe-area-inset-bottom));
      max-width: 640px;
      margin: 0 auto;
    }
    .page.active { display: block; }

    /* ============ HEADER ============ */
    .page-header {
      text-align: center;
      margin-bottom: 20px;
    }
    .page-header .page-emoji { font-size: 48px; display: block; }
    .page-header h1 {
      font-family: 'Fredoka One', cursive;
      font-size: 28px;
      line-height: 1.2;
      margin-top: 4px;
    }
    .page-header p { color: var(--muted); font-size: 14px; font-weight: 700; margin-top: 4px; }

    /* ============ CARDS ============ */
    .card {
      background: var(--white);
      border-radius: 24px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 4px 0 rgba(0,0,0,.07), 0 8px 24px rgba(0,0,0,.05);
    }
    .card-title {
      font-family: 'Fredoka One', cursive;
      font-size: 18px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ============ BUTTONS ============ */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 20px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-family: 'Fredoka One', cursive;
      font-size: 16px;
      transition: transform .1s, box-shadow .1s;
      box-shadow: 0 5px 0 rgba(0,0,0,.15);
      -webkit-appearance: none;
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
    }
    .btn:active { transform: translateY(3px); box-shadow: 0 2px 0 rgba(0,0,0,.15); }
    @media (hover: hover) {
      .btn:hover { transform: translateY(-2px); box-shadow: 0 7px 0 rgba(0,0,0,.15); }
    }

    .btn-red    { background: var(--red);    color: #fff; }
    .btn-orange { background: var(--orange); color: #fff; }
    .btn-yellow { background: var(--yellow); color: var(--text); }
    .btn-green  { background: var(--green);  color: #fff; }
    .btn-teal   { background: var(--teal);   color: #fff; }
    .btn-blue   { background: var(--blue);   color: #fff; }
    .btn-purple { background: var(--purple); color: #fff; }
    .btn-pink   { background: var(--pink);   color: #fff; }
    .btn-white  { background: var(--white);  color: var(--text); border: 3px solid #EEE; box-shadow: 0 4px 0 #DDD; }

    .btn-lg   { font-size: 20px; padding: 18px 28px; }
    .btn-sm   { font-size: 13px; padding: 10px 14px; }
    .btn-full { width: 100%; }

    .btn-row { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px; }

    /* ============ SCORE BADGE ============ */
    .top-score-bar {
      background: linear-gradient(135deg, var(--yellow), var(--orange));
      border-radius: 20px;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      box-shadow: 0 5px 0 rgba(0,0,0,.12);
    }
    .top-score-bar .tname { font-family: 'Fredoka One', cursive; font-size: 22px; }
    .top-score-bar .tball { font-family: 'Fredoka One', cursive; font-size: 22px; background: rgba(255,255,255,.5); padding: 6px 16px; border-radius: 999px; }

    /* ============ PROFILE ============ */
    .avatar-big {
      width: 96px; height: 96px;
      border-radius: 32px;
      background: linear-gradient(135deg, var(--orange), var(--pink));
      display: flex; align-items: center; justify-content: center;
      font-size: 48px;
      box-shadow: 0 6px 0 rgba(0,0,0,.12);
      overflow: hidden;
      flex-shrink: 0;
    }
    .avatar-big img { width:100%; height:100%; object-fit:cover; display:block; }

    .profile-row { display: flex; gap: 16px; align-items: center; }
    .profile-info { flex: 1; }
    .profile-name { font-family: 'Fredoka One', cursive; font-size: 26px; }

    .badge-pill {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 14px; border-radius: 999px;
      font-size: 13px; font-weight: 800;
    }
    .badge-pill.green  { background: #E8FFE8; color: #2D8A3E; }
    .badge-pill.orange { background: #FFF2E0; color: #C0520A; }

    /* ============ PROGRESS ============ */
    .progress-wrap { background: #F0F0F0; border-radius: 999px; height: 16px; overflow: hidden; margin: 8px 0; }
    .progress-fill { height: 100%; border-radius: 999px; background: linear-gradient(90deg, var(--green), var(--teal)); transition: width .5s ease; }

    /* ============ WORD CARD ============ */
    .word-card-big { text-align: center; padding: 24px; }
    .word-emoji-box {
      width: 150px; height: 150px;
      margin: 0 auto 16px;
      border-radius: 32px;
      background: linear-gradient(135deg, #E8F5FF, #D0EAFF);
      display: flex; align-items: center; justify-content: center;
      font-size: 80px;
      box-shadow: 0 6px 0 rgba(77,150,255,.2);
      position: relative; overflow: hidden;
    }
    .word-emoji-box img {
      width:100%; height:100%; object-fit:cover;
      position:absolute; top:0; left:0; border-radius:32px;
    }
    .word-text {
      font-family: 'Fredoka One', cursive;
      font-size: 44px;
      color: var(--blue);
      margin-bottom: 8px;
    }
    .word-hint {
      font-size: 15px; font-weight: 700; color: var(--muted);
      background: #F5F5F5; border-radius: 12px;
      padding: 8px 16px; display: inline-block;
    }

    .mic-result {
      font-family: 'Fredoka One', cursive;
      font-size: 20px; padding: 12px 20px;
      border-radius: 999px; text-align: center;
      margin-top: 12px; background: #F5F5F5; transition: .3s;
    }
    .mic-result.good { background: #E8FFE8; color: var(--green); }
    .mic-result.bad  { background: #FFEEEE; color: var(--red); }

    /* topic pills */
    .topic-pills { display: flex; flex-wrap: wrap; gap: 8px; }
    .topic-pill {
      padding: 10px 16px; border-radius: 999px;
      border: 3px solid transparent;
      font-family: 'Fredoka One', cursive; font-size: 15px;
      cursor: pointer; transition: .15s;
      background: #F5F5F5; color: var(--text);
    }
    .topic-pill:hover { transform: scale(1.05); }
    .topic-pill.active { border-color: var(--blue); background: #E0F0FF; color: var(--blue); }

    /* ============ SENTENCE BUILDER ============ */
    .sentence-box {
      min-height: 72px;
      background: linear-gradient(135deg, #F0FFF8, #E8FFF2);
      border: 3px dashed var(--green); border-radius: 20px;
      padding: 12px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center;
    }
    .sentence-empty { color: var(--muted); font-weight: 700; font-size: 14px; }
    .token {
      background: var(--green); color: #fff;
      padding: 8px 14px; border-radius: 999px;
      font-family: 'Fredoka One', cursive; font-size: 16px;
      cursor: pointer; transition: .1s;
    }
    .token:hover { opacity: .8; }

    .chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .chip {
      background: var(--white); border: 3px solid #DDD;
      padding: 10px 16px; border-radius: 999px;
      cursor: pointer; font-family: 'Fredoka One', cursive; font-size: 15px; transition: .15s;
      -webkit-appearance: none;
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
    }
    .chip:active { border-color: var(--blue); background: #E0F0FF; color: var(--blue); transform: scale(1.05); }
    @media (hover: hover) {
      .chip:hover { border-color: var(--blue); background: #E0F0FF; color: var(--blue); transform: scale(1.05); }
    }
    .chip.on { border-color: var(--green); background: #E8FFE8; color: var(--green); }

    .mode-tabs { display: flex; gap: 8px; margin-bottom: 12px; }
    .mode-tab {
      flex: 1; padding: 10px; border-radius: 16px;
      border: 3px solid #EEE; background: #F5F5F5;
      font-family: 'Fredoka One', cursive; font-size: 14px;
      cursor: pointer; text-align: center; transition: .15s;
    }
    .mode-tab.active { border-color: var(--green); background: #E8FFE8; color: var(--green); }

    /* ============ TASKS ============ */
    .task-card {
      border-radius: 24px; padding: 20px; margin-bottom: 16px;
      position: relative; overflow: hidden;
    }
    .task-card::before {
      content: ''; position: absolute;
      top: -20px; right: -20px;
      width: 100px; height: 100px;
      border-radius: 50%; background: rgba(255,255,255,.2);
    }
    .task-card.yellow-theme { background: linear-gradient(135deg, var(--yellow), var(--orange)); color: var(--text); }
    .task-title-big { font-family: 'Fredoka One', cursive; font-size: 22px; margin-bottom: 6px; }

    /* ============ REWARDS ============ */
    .reward-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .reward-item {
      background: var(--white); border-radius: 20px; padding: 16px;
      text-align: center; box-shadow: 0 4px 0 rgba(0,0,0,.07);
      border: 3px solid #F0F0F0;
    }
    .reward-item.unlocked { border-color: var(--yellow); background: linear-gradient(135deg, #FFFDE0, #FFF8C0); }
    .reward-emoji { font-size: 40px; display: block; margin-bottom: 8px; }
    .reward-name { font-family: 'Fredoka One', cursive; font-size: 16px; }
    .reward-req  { font-size: 12px; font-weight: 700; color: var(--muted); margin-top: 4px; }

    .stars-row { display: flex; gap: 4px; justify-content: center; }
    .star { font-size: 24px; filter: grayscale(1) opacity(.3); transition: .3s; }
    .star.lit { filter: none; }

    /* ============ TIPS ============ */
    .tip-item {
      display: flex; gap: 12px; align-items: flex-start;
      padding: 14px; background: var(--white);
      border-radius: 16px; margin-bottom: 10px;
      box-shadow: 0 3px 0 rgba(0,0,0,.06);
    }
    .tip-num {
      width: 36px; height: 36px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-family: 'Fredoka One', cursive; font-size: 18px; flex-shrink: 0;
    }
    .tip-text { font-size: 14px; font-weight: 700; line-height: 1.5; }

    .section-label {
      font-family: 'Fredoka One', cursive; font-size: 14px;
      color: var(--muted); text-transform: uppercase;
      letter-spacing: 1px; margin-bottom: 8px;
    }

    select {
      width: 100%; padding: 12px 16px; border-radius: 16px;
      border: 3px solid #DDD;
      font-family: 'Nunito', sans-serif; font-size: 16px; font-weight: 700;
      background: var(--white); color: var(--text); outline: none; cursor: pointer;
      -webkit-appearance: none;
      appearance: none;
    }
    select:focus { border-color: var(--blue); }

    /* ============ ANIMATIONS ============ */
    @keyframes bounce {
      0%,100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }
    @keyframes confettiFall {
      0%   { transform: translateY(-20px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
    @keyframes fadeIn {
      from { opacity:0; transform:translateY(12px); }
      to   { opacity:1; transform:translateY(0); }
    }

    .bounce { animation: bounce 1.5s infinite; }
    .page.active .card { animation: fadeIn .3s ease both; }

    .confetti-piece {
      position: fixed; width: 10px; height: 14px; border-radius: 3px;
      top: -20px; animation: confettiFall 2s ease-in forwards;
      z-index: 9999; pointer-events: none;
    }

    @media (max-width: 400px) {
      .reward-grid { grid-template-columns: 1fr 1fr; }
      .word-text { font-size: 34px; }
    }
  </style>
</head>
<body>

<!-- ======================= NAV BAR ======================= -->
<nav class="nav-bar">
  <button class="nav-tab active" onclick="showPage('home')">
    <span class="nav-icon">üè†</span>Home
  </button>
  <button class="nav-tab" onclick="showPage('words')">
    <span class="nav-icon">üÉè</span>Words
  </button>
  <button class="nav-tab" onclick="showPage('sentence')">
    <span class="nav-icon">üìù</span>Sentences
  </button>
  <button class="nav-tab" onclick="showPage('task')">
    <span class="nav-icon">üéØ</span>Task
  </button>
  <button class="nav-tab" onclick="showPage('reward')">
    <span class="nav-icon">üèÜ</span>Rewards
  </button>
  <button class="nav-tab" onclick="showPage('parent')">
    <span class="nav-icon">üë®‚Äçüë©‚Äçüë¶</span>Parents
  </button>
</nav>

<!-- Install Banner (iOS: manual steps / Android: native prompt) -->
<div id="installBanner" style="display:none; position:fixed; bottom:0; left:0; right:0; z-index:200;
  background:linear-gradient(135deg,#FF9A3C,#C77DFF); color:#fff;
  padding:14px 16px calc(14px + env(safe-area-inset-bottom));
  font-family:'Nunito',sans-serif; font-size:14px; font-weight:800;
  text-align:center; box-shadow: 0 -4px 20px rgba(0,0,0,.25);">
  <div id="bannerContent"></div>
  <button id="androidInstallBtn" style="display:none; margin-top:8px; background:#fff; color:#FF9A3C;
    border:none; border-radius:999px; padding:10px 24px; font-family:'Fredoka One',cursive;
    font-size:16px; cursor:pointer; box-shadow:0 3px 0 rgba(0,0,0,.15);">
    üì≤ Install App
  </button>
  <button onclick="dismissBanner()"
    style="position:absolute; top:10px; right:12px; background:rgba(255,255,255,.25);
    border:none; color:#fff; border-radius:50%; width:28px; height:28px;
    font-size:14px; cursor:pointer; display:flex; align-items:center; justify-content:center; padding:0;">‚úï</button>
</div>

<!-- ======================= PAGE 1: HOME ======================= -->
<div class="page active" id="page-home" style="background: var(--page-home);">
  <div class="top-score-bar">
    <span class="tname">üåü Hello, Jurabek!</span>
    <span class="tball">‚≠ê <span id="score">0</span></span>
  </div>

  <div class="card">
    <div class="profile-row">
      <div class="avatar-big">
        <img id="avatarImg" src="avatar.jpg" alt="Jurabek" onerror="this.style.display='none'">
        <span id="avatarEmoji">üòä</span>
      </div>
      <div class="profile-info">
        <div class="profile-name">Jurabek</div>
        <div id="todayStr" style="font-size:13px; font-weight:700; color: var(--muted); margin-top:4px;"></div>
        <div style="display:flex; flex-wrap:wrap; gap:6px; margin-top:10px;">
          <span class="badge-pill green">üî• <span id="streak">0</span> days in a row!</span>
          <span class="badge-pill orange">üéñÔ∏è <span id="badge">Beginner</span></span>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">üìä Today's Score</div>
    <div style="text-align:center; padding: 10px 0;">
      <div style="font-family:'Fredoka One',cursive; font-size:60px; color:var(--orange); line-height:1;">
        <span id="todayScore">0</span>
      </div>
      <div style="font-size:14px; font-weight:700; color:var(--muted);">points today</div>
    </div>
    <div class="stars-row" id="starsRow">
      <span class="star">‚≠ê</span>
      <span class="star">‚≠ê</span>
      <span class="star">‚≠ê</span>
      <span class="star">‚≠ê</span>
      <span class="star">‚≠ê</span>
    </div>
  </div>

  <div class="card" style="text-align:center;">
    <div style="font-size:56px;" class="bounce">üé§</div>
    <div style="font-family:'Fredoka One',cursive; font-size:22px; margin: 8px 0;">Let's Play!</div>
    <p style="color:var(--muted); font-size:14px; font-weight:700; margin-bottom:16px;">Practice 10 minutes every day</p>
    <div class="btn-row" style="justify-content:center;">
      <button class="btn btn-blue btn-lg" onclick="showPage('words')">üÉè Word Game</button>
      <button class="btn btn-green btn-lg" onclick="showPage('sentence')">üìù Make a Sentence</button>
    </div>
  </div>

  <div style="text-align:center; margin-top:8px;">
    <button class="btn btn-white btn-sm" id="resetBtn">üîÑ Reset Everything</button>
  </div>
</div>

<!-- ======================= PAGE 2: WORDS ======================= -->
<div class="page" id="page-words" style="background: var(--page-words);">
  <div class="page-header">
    <span class="page-emoji">üÉè</span>
    <h1 style="color: var(--blue);">Word Cards</h1>
    <p>Look at the picture and say the word!</p>
  </div>

  <div class="card">
    <div class="section-label">Choose a Topic</div>
    <div class="topic-pills" id="topicPills"></div>
  </div>

  <div class="card word-card-big">
    <div class="word-emoji-box">
      <img id="wordImg" alt="Word picture" style="display:none;">
      <span id="emojiFallback">üè†</span>
    </div>
    <div class="word-text" id="wordEn">House</div>
    <div class="word-hint" id="hint">Say: "What is this?"</div>
  </div>

  <div class="mic-result" id="micResult">üéß Ready...</div>

  <div class="btn-row" style="justify-content:center;">
    <button class="btn btn-teal btn-lg" id="sayBtn">üîä Listen</button>
    <button class="btn btn-blue btn-lg" id="micBtn">üé§ I Said It!</button>
  </div>
  <div class="btn-row" style="justify-content:center; margin-top:4px;">
    <button class="btn btn-green" id="saidBtn">‚úÖ I Said It Right</button>
    <button class="btn btn-orange" id="repeatBtn">üîÅ Repeat</button>
    <button class="btn btn-white" id="nextBtn">‚û°Ô∏è Next</button>
  </div>
  <div class="btn-row" style="justify-content:center;">
    <button class="btn btn-purple btn-sm" id="shuffleBtn">üé≤ Shuffle</button>
    <select id="modeSelect" style="max-width:200px; padding:10px 12px; font-size:14px;">
      <option value="easy">Easy</option>
      <option value="mid" selected>Medium</option>
      <option value="hard">Hard</option>
    </select>
  </div>

  <div class="card" style="margin-top:8px; text-align:center;">
    <div style="font-size:12px; font-weight:700; color:var(--muted);">
      ‚úÖ "I Said It Right" ‚Üí +2 points &nbsp;‚Ä¢&nbsp; üé§ Microphone ‚Üí +3 points
    </div>
  </div>
</div>

<!-- ======================= PAGE 3: SENTENCE BUILDER ======================= -->
<div class="page" id="page-sentence" style="background: var(--page-sent);">
  <div class="page-header">
    <span class="page-emoji">üìù</span>
    <h1 style="color: var(--green);">Make a Sentence</h1>
    <p>Tap the chips to build a sentence!</p>
  </div>

  <div class="mode-tabs">
    <div class="mode-tab active" onclick="setMode('easy',this)">üòä Easy</div>
    <div class="mode-tab" onclick="setMode('mid',this)">üôÇ Medium</div>
    <div class="mode-tab" onclick="setMode('hard',this)">üòé Hard</div>
  </div>

  <div class="card">
    <div class="section-label">Your Sentence üëá</div>
    <div class="sentence-box" id="sentenceBox">
      <span class="sentence-empty">Tap the chips to make a sentence...</span>
    </div>
    <div class="btn-row" style="margin-top:14px;">
      <button class="btn btn-teal" id="saySentenceBtn">üîä Listen</button>
      <button class="btn btn-green" id="doneSentenceBtn">üèÅ Done!</button>
      <button class="btn btn-white btn-sm" id="clearSentenceBtn">üßπ Clear</button>
    </div>
  </div>

  <div class="card">
    <div class="section-label">Words</div>
    <div class="chips" id="chips"></div>
  </div>

  <div class="card">
    <div class="section-label">Quick Templates</div>
    <div class="chips" id="templates"></div>
    <div style="font-size:12px; font-weight:700; color:var(--muted); margin-top:8px;">
      Tap a template, then add more words!
    </div>
  </div>
</div>

<!-- ======================= PAGE 4: TASKS ======================= -->
<div class="page" id="page-task" style="background: var(--page-task);">
  <div class="page-header">
    <span class="page-emoji">üéØ</span>
    <h1 style="color: var(--orange);">Today's Task</h1>
    <p>A new challenge every day!</p>
  </div>

  <div class="task-card yellow-theme">
    <div class="task-title-big" id="taskTitle">‚Äî</div>
    <div id="taskDesc" style="font-size:14px; font-weight:700; opacity:.85; margin-bottom:14px;">‚Äî</div>
    <div style="background:rgba(255,255,255,.3); border-radius:999px; height:18px; overflow:hidden; margin-bottom:8px;">
      <div id="taskBar" style="height:100%; border-radius:999px; background:rgba(255,255,255,.7); width:0%; transition:.5s;"></div>
    </div>
    <div style="font-family:'Fredoka One',cursive; font-size:18px;">
      <span id="taskDone">0</span> / <span id="taskGoal">0</span>
    </div>
  </div>

  <div class="btn-row" style="justify-content:center;">
    <button class="btn btn-green btn-lg" id="claimBtn">üéÅ Claim Reward!</button>
    <button class="btn btn-white" id="newTaskBtn">üé≤ New Task</button>
  </div>

  <div class="card" style="margin-top:20px;">
    <div class="card-title">üìã All Tasks</div>
    <div id="allTasks"></div>
  </div>
</div>

<!-- ======================= PAGE 5: REWARDS ======================= -->
<div class="page" id="page-reward" style="background: var(--page-reward);">
  <div class="page-header">
    <span class="page-emoji">üèÜ</span>
    <h1 style="color: var(--purple);">My Rewards</h1>
    <p>The more points ‚Äî the more rewards!</p>
  </div>

  <div class="card" style="text-align:center;">
    <div style="font-family:'Fredoka One',cursive; font-size:16px; color:var(--muted);">Total Points</div>
    <div style="font-family:'Fredoka One',cursive; font-size:72px; color:var(--purple); line-height:1.1;">
      <span id="rewardScore">0</span>
    </div>
    <div class="stars-row" id="rewardStars" style="margin-top:8px;">
      <span class="star">‚≠ê</span><span class="star">‚≠ê</span><span class="star">‚≠ê</span>
      <span class="star">‚≠ê</span><span class="star">‚≠ê</span>
    </div>
  </div>

  <div class="reward-grid">
    <div class="reward-item" id="badge-beginner">
      <span class="reward-emoji">üå±</span>
      <div class="reward-name">Beginner</div>
      <div class="reward-req">0+ points</div>
    </div>
    <div class="reward-item" id="badge-brave">
      <span class="reward-emoji">ü¶Å</span>
      <div class="reward-name">Brave</div>
      <div class="reward-req">50+ points</div>
    </div>
    <div class="reward-item" id="badge-star">
      <span class="reward-emoji">‚≠ê</span>
      <div class="reward-name">Star</div>
      <div class="reward-req">120+ points</div>
    </div>
    <div class="reward-item" id="badge-champion">
      <span class="reward-emoji">üèÜ</span>
      <div class="reward-name">Champion</div>
      <div class="reward-req">220+ points</div>
    </div>
    <div class="reward-item" id="badge-super">
      <span class="reward-emoji">üöÄ</span>
      <div class="reward-name">Super Star</div>
      <div class="reward-req">400+ points</div>
    </div>
    <div class="reward-item" id="badge-legend">
      <span class="reward-emoji">üëë</span>
      <div class="reward-name">Legend</div>
      <div class="reward-req">700+ points</div>
    </div>
  </div>

  <div class="card" style="margin-top:16px; text-align:center; background: linear-gradient(135deg, #F5E8FF, #EED9FF);">
    <div style="font-family:'Fredoka One',cursive; font-size:20px; margin-bottom:4px;">üéñÔ∏è Current Title</div>
    <div style="font-family:'Fredoka One',cursive; font-size:32px; color:var(--purple);" id="badgeDisplay">Beginner</div>
  </div>
</div>

<!-- ======================= PAGE 6: PARENTS ======================= -->
<div class="page" id="page-parent" style="background: var(--page-parent);">
  <div class="page-header">
    <span class="page-emoji">üë®‚Äçüë©‚Äçüë¶</span>
    <h1 style="color: var(--teal);">For Parents</h1>
    <p>Tips to help your child</p>
  </div>

  <div class="card" style="background: linear-gradient(135deg, #E8FFF8, #D0FFF0);">
    <div class="card-title">‚è∞ Daily Goal</div>
    <div style="font-family:'Fredoka One',cursive; font-size:48px; text-align:center; color:var(--teal);">10 minutes</div>
    <div style="text-align:center; font-size:14px; font-weight:700; color:var(--muted);">at the same time every day</div>
  </div>

  <div class="tip-item">
    <div class="tip-num" style="background:#FFE8E8; color:var(--red);">1</div>
    <div class="tip-text">If your child says something wrong ‚Äî don't say <strong>"no"</strong>. Gently repeat the correct version: <em>"Yes, this is a dog!"</em></div>
  </div>
  <div class="tip-item">
    <div class="tip-num" style="background:#E8F0FF; color:var(--blue);">2</div>
    <div class="tip-text">When your child says a word, expand it into a sentence: <strong>"Dog" ‚Üí "The dog is big and fluffy!"</strong></div>
  </div>
  <div class="tip-item">
    <div class="tip-num" style="background:#E8FFE8; color:var(--green);">3</div>
    <div class="tip-text">Practice every day ‚Äî <strong>keeping the streak</strong> is a great motivator for kids!</div>
  </div>
  <div class="tip-item">
    <div class="tip-num" style="background:#FFF3E0; color:var(--orange);">4</div>
    <div class="tip-text">Celebrate every success with praise: <strong>"Great job! You said it perfectly!"</strong></div>
  </div>
  <div class="tip-item">
    <div class="tip-num" style="background:#F5E8FF; color:var(--purple);">5</div>
    <div class="tip-text">If your child's speech is very delayed, consider <strong>consulting a speech therapist</strong> alongside this app.</div>
  </div>

  <div class="card" style="background: linear-gradient(135deg, #FFF8D0, #FFEEA0); margin-top:8px;">
    <div class="card-title">üí° About the Microphone</div>
    <div style="font-size:14px; font-weight:700; line-height:1.6;">
      Works best in <strong>Safari (iPhone)</strong> or <strong>Samsung Internet / Chrome (Android)</strong>.
      Allow microphone access when prompted. If it doesn't work ‚Äî use
      <strong>‚úÖ "I Said It Right"</strong> instead.
    </div>
  </div>

  <div class="card" style="background: linear-gradient(135deg, #E0F4FF, #C8E8FF); margin-top:8px;">
    <div class="card-title">üçé Install on iPhone</div>
    <div style="font-size:14px; font-weight:700; line-height:2.1;">
      <div>1Ô∏è‚É£ Open in <strong>Safari</strong> browser</div>
      <div>2Ô∏è‚É£ Tap the <strong>Share</strong> button (‚Üë at the bottom)</div>
      <div>3Ô∏è‚É£ Scroll and tap <strong>"Add to Home Screen"</strong></div>
      <div>4Ô∏è‚É£ Tap <strong>"Add"</strong> ‚Äî done! üéâ</div>
    </div>
  </div>

  <div class="card" style="background: linear-gradient(135deg, #E8FFE8, #C8F0C8); margin-top:8px;">
    <div class="card-title">ü§ñ Install on Samsung / Android</div>
    <div style="font-size:14px; font-weight:700; line-height:2.1;">
      <div>1Ô∏è‚É£ Open in <strong>Samsung Internet</strong> or <strong>Chrome</strong></div>
      <div>2Ô∏è‚É£ A pop-up <strong>"Install App"</strong> will appear automatically</div>
      <div>3Ô∏è‚É£ Tap <strong>"Install"</strong> ‚Äî done! üéâ</div>
      <div style="margin-top:4px; font-size:12px; color:var(--muted);">
        Or: tap ‚ãÆ menu ‚Üí <strong>"Add to Home screen"</strong>
      </div>
    </div>
  </div>
</div>

<!-- ======================= SCRIPTS ======================= -->
<script>
  // ========================= DATA =========================
  const TOPICS = {
    "Home üè†": [
      {w:"house",e:"üè†"},{w:"room",e:"üõãÔ∏è"},{w:"door",e:"üö™"},{w:"window",e:"ü™ü"},
      {w:"table",e:"ü™ë"},{w:"chair",e:"ü™ë"},{w:"bed",e:"üõèÔ∏è"},{w:"lamp",e:"üí°"},
      {w:"book",e:"üìò"},{w:"rug",e:"üß∂"},{w:"clock",e:"üïí"},{w:"key",e:"üîë"},
      {w:"phone",e:"üì±"},{w:"TV",e:"üì∫"},{w:"kitchen",e:"üç≥"},{w:"bathroom",e:"üõÅ"}
    ],
    "Food üçΩÔ∏è": [
      {w:"bread",e:"üçû"},{w:"water",e:"üíß"},{w:"milk",e:"ü•õ"},{w:"tea",e:"üçµ"},
      {w:"apple",e:"üçé"},{w:"banana",e:"üçå"},{w:"rice",e:"üçö"},{w:"soup",e:"ü•£"},
      {w:"meat",e:"üçñ"},{w:"egg",e:"ü•ö"},{w:"cheese",e:"üßÄ"},{w:"candy",e:"üç¨"},
      {w:"salt",e:"üßÇ"},{w:"spoon",e:"ü•Ñ"},{w:"plate",e:"üçΩÔ∏è"},{w:"cup",e:"ü•õ"}
    ],
    "Clothes üëï": [
      {w:"shirt",e:"üëï"},{w:"pants",e:"üëñ"},{w:"socks",e:"üß¶"},{w:"shoes",e:"üëü"},
      {w:"hat",e:"üß¢"},{w:"jacket",e:"üß•"},{w:"dress",e:"üëó"},{w:"scarf",e:"üß£"},
      {w:"gloves",e:"üß§"},{w:"belt",e:"üß∑"}
    ],
    "School üéí": [
      {w:"school",e:"üè´"},{w:"teacher",e:"üë©‚Äçüè´"},{w:"friend",e:"üßí"},{w:"notebook",e:"üìí"},
      {w:"pen",e:"üñäÔ∏è"},{w:"pencil",e:"‚úèÔ∏è"},{w:"colors",e:"üé®"},{w:"game",e:"üé≤"},
      {w:"ball",e:"‚öΩ"},{w:"bag",e:"üéí"}
    ],
    "Body üë¶": [
      {w:"eye",e:"üëÄ"},{w:"ear",e:"üëÇ"},{w:"nose",e:"üëÉ"},{w:"mouth",e:"üëÑ"},
      {w:"tooth",e:"ü¶∑"},{w:"hand",e:"‚úã"},{w:"foot",e:"ü¶∂"},{w:"head",e:"üß†"},
      {w:"hair",e:"üíá"},{w:"belly",e:"üôÇ"}
    ],
    "Animals üêæ": [
      {w:"cat",e:"üê±"},{w:"dog",e:"üê∂"},{w:"bird",e:"üê¶"},{w:"fish",e:"üê†"},
      {w:"cow",e:"üêÑ"},{w:"horse",e:"üê¥"},{w:"sheep",e:"üêë"},{w:"duck",e:"ü¶Ü"},
      {w:"rabbit",e:"üê∞"},{w:"bear",e:"üêª"},{w:"lion",e:"ü¶Å"},{w:"elephant",e:"üêò"}
    ],
    "Actions üèÉ": [
      {w:"I go",e:"üö∂"},{w:"I run",e:"üèÉ"},{w:"I play",e:"üéÆ"},{w:"I drink",e:"ü•§"},
      {w:"I eat",e:"üçΩÔ∏è"},{w:"I see",e:"üëÄ"},{w:"I give",e:"ü§≤"},{w:"I take",e:"ü´¥"},
      {w:"I open",e:"üîì"},{w:"I close",e:"üîí"},{w:"I wash",e:"üßº"},{w:"I sleep",e:"üò¥"}
    ],
    "Colors üé®": [
      {w:"red",e:"üî¥"},{w:"blue",e:"üîµ"},{w:"green",e:"üü¢"},{w:"yellow",e:"üü°"},
      {w:"orange",e:"üü†"},{w:"purple",e:"üü£"},{w:"pink",e:"ü©∑"},{w:"white",e:"‚ö™"},
      {w:"black",e:"‚ö´"},{w:"brown",e:"üü§"}
    ]
  };

  const SENTENCE_BANK = {
    easy: {
      who:["I","he","she","mom","dad"],
      do:["eat","drink","play","see","like"],
      what:["apple","milk","bread","ball","book"]
    },
    mid: {
      who:["I","Jurabek","mom","dad","the cat"],
      do:["eat","drink","play","see","like","want"],
      what:["apple","milk","bread","ball","book","dog","chair"],
      where:["at home","at school","outside","in the kitchen"],
      how:["fast","slowly","well","big","small"]
    },
    hard: {
      who:["I","Jurabek","mom","dad","my friend"],
      do:["eat","drink","play","read","see","like","want","have"],
      what:["apple","milk","bread","rice","book","ball","car","pencil"],
      where:["at home","at school","outside","in the kitchen","in my room"],
      when:["now","later","in the morning","in the evening"],
      how:["very well","quickly","slowly","every day"]
    }
  };

  const TEMPLATES = [
    "I want ...", "This is ...", "I see ...", "I eat ...", "I drink ...",
    "I play with ...", "Where is ...?", "This is big", "This is small",
    "I like ..."
  ];

  const DAILY_TASKS = [
    { title:"Say 10 words!", desc:"Say 10 words from the cards. Press ‚úÖ for each one.", goal:10, kind:"said" },
    { title:"Make 5 sentences!", desc:"Build 5 sentences and press üèÅ Done.", goal:5, kind:"sent" },
    { title:"3 'I...' sentences", desc:"Make 3 sentences starting with 'I': 'I drink milk'.", goal:3, kind:"iSent" },
    { title:"8 Body words", desc:"Say 8 body words (eye, ear, nose‚Ä¶).", goal:8, kind:"bodyWords" },
    { title:"8 Food words", desc:"Say 8 food words (bread, milk, apple‚Ä¶).", goal:8, kind:"foodWords" }
  ];

  // ========================= STATE =========================
  const $ = id => document.getElementById(id);
  const LS = {
    score:"juren_score", todayScore:"juren_today", lastDate:"juren_date",
    streak:"juren_streak", task:"juren_task", taskDone:"juren_taskdone", badge:"juren_badge"
  };

  let score = 0, todayScore = 0, streak = 0;
  let currentTopicName = Object.keys(TOPICS)[0];
  let words = [...TOPICS[currentTopicName]];
  let idx = 0;
  let sentence = [];
  let currentMode = "mid";

  // ========================= NAVIGATION =========================
  function showPage(name) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.getElementById('page-'+name).classList.add('active');
    const tabs = document.querySelectorAll('.nav-tab');
    const i = ['home','words','sentence','task','reward','parent'].indexOf(name);
    if (i >= 0) tabs[i].classList.add('active');
    if (name === 'reward') updateRewardPage();
    if (name === 'task') renderAllTasks();
  }

  // ========================= DATE HELPERS =========================
  function ymd(d) {
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }
  function formatToday(d) {
    try { return d.toLocaleDateString("en-US", {weekday:"long",year:"numeric",month:"long",day:"numeric"}); }
    catch(e) { return d.toDateString(); }
  }
  function loadNumber(key, def=0) { const v=Number(localStorage.getItem(key)??def); return isFinite(v)?v:def; }
  function saveNumber(key, val) { localStorage.setItem(key, String(val)); }

  // ========================= SCORE =========================
  function addScore(n) {
    score += n; todayScore += n;
    $("score").textContent = score;
    $("todayScore").textContent = todayScore;
    saveNumber(LS.score, score);
    saveNumber(LS.todayScore, todayScore);
    setBadge();
    updateStars();
  }

  function updateStars() {
    const row = $("starsRow");
    if (!row) return;
    const stars = row.querySelectorAll('.star');
    const lit = Math.min(5, Math.floor(todayScore / 4));
    stars.forEach((s, i) => s.classList.toggle('lit', i < lit));
  }

  function setBadge() {
    let b = "Beginner";
    if (score >= 50) b = "Brave";
    if (score >= 120) b = "Star";
    if (score >= 220) b = "Champion";
    if (score >= 400) b = "Super Star";
    if (score >= 700) b = "Legend";
    localStorage.setItem(LS.badge, b);
    $("badge").textContent = b;
    $("badgeDisplay") && ($("badgeDisplay").textContent = b);
  }

  // ========================= CONFETTI =========================
  function confetti() {
    const colors = ['#FF6B6B','#FFD93D','#6BCB77','#4D96FF','#C77DFF','#FF9A3C','#FF85A1'];
    for (let i = 0; i < 30; i++) {
      const el = document.createElement('div');
      el.className = 'confetti-piece';
      el.style.cssText = `left:${Math.random()*100}vw; background:${colors[Math.floor(Math.random()*colors.length)]}; animation-delay:${Math.random()}s; transform:rotate(${Math.random()*360}deg);`;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 3000);
    }
  }

  // ========================= TTS (iOS-compatible) =========================
  let ttsReady = false;

  // iOS Safari requires voices to be loaded after user interaction
  function ensureTTS() {
    if (!("speechSynthesis" in window)) return false;
    // Warm up on iOS with a silent utterance
    if (!ttsReady) {
      const u = new SpeechSynthesisUtterance(" ");
      u.volume = 0; u.rate = 1;
      window.speechSynthesis.speak(u);
      ttsReady = true;
    }
    return true;
  }

  function speak(text) {
    if (!("speechSynthesis" in window)) {
      alert("Please try in Safari browser for voice support.");
      return;
    }
    window.speechSynthesis.cancel();

    const doSpeak = () => {
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "en-US";
      u.rate = 0.8; u.pitch = 1.15;

      // Prefer an English voice if available
      const voices = window.speechSynthesis.getVoices();
      const enVoice = voices.find(v => v.lang.startsWith("en") && !v.name.includes("compact")) ||
                      voices.find(v => v.lang.startsWith("en"));
      if (enVoice) u.voice = enVoice;

      window.speechSynthesis.speak(u);
    };

    // iOS: voices may not be ready yet
    if (window.speechSynthesis.getVoices().length > 0) {
      doSpeak();
    } else {
      window.speechSynthesis.onvoiceschanged = () => { doSpeak(); };
      // Fallback timeout
      setTimeout(doSpeak, 300);
    }
  }

  // ========================= STT =========================
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  function norm(s) {
    return (s||"").toLowerCase().replace(/[^a-z0-9\s]/g,"").replace(/\s+/g," ").trim();
  }
  function isClose(heard, target) {
    const a=norm(heard), b=norm(target);
    if (!a||!b) return false;
    if (a===b||a.includes(b)||b.includes(a)) return true;
    if (Math.abs(a.length-b.length)<=2) {
      let same=0;
      for(let i=0;i<Math.min(a.length,b.length);i++) if(a[i]===b[i]) same++;
      if(same>=Math.min(a.length,b.length)-2) return true;
    }
    return false;
  }

  function startMicCheck(getTarget) {
    if (!SpeechRecognition) { alert("Microphone check is not supported in this browser. Try Chrome or Edge."); return; }
    const rec = new SpeechRecognition();
    rec.lang = "en-US"; rec.interimResults = false; rec.maxAlternatives = 1;

    const el = $("micResult");
    el.className = "mic-result";
    el.textContent = "üéß Listening...";

    rec.onresult = (e) => {
      const heard = e.results[0][0].transcript || "";
      const ok = isClose(heard, getTarget());
      if (ok) {
        el.className = "mic-result good";
        el.textContent = `‚úÖ Great! "${heard}"`;
        addScore(3); confetti();
        updateTaskProgress("said", 1);
      } else {
        el.className = "mic-result bad";
        el.textContent = `üîÅ Try again: "${heard}"`;
        addScore(1);
      }
    };
    rec.onerror = () => {
      el.className = "mic-result bad";
      el.textContent = "‚ö†Ô∏è Please check microphone access";
    };
    rec.start();
  }

  // ========================= DAILY CHECK =========================
  function dailyCheck() {
    const today = new Date();
    const todayKey = ymd(today);
    $("todayStr").textContent = formatToday(today);
    const last = localStorage.getItem(LS.lastDate);
    if (!last) {
      localStorage.setItem(LS.lastDate, todayKey);
      streak = todayScore = 0;
      saveNumber(LS.streak, 0); saveNumber(LS.todayScore, 0);
      localStorage.removeItem(LS.taskDone);
    } else if (last !== todayKey) {
      const prev = loadNumber(LS.todayScore, 0);
      const diff = Math.round((new Date(todayKey+"T00:00:00") - new Date(last+"T00:00:00")) / 86400000);
      if (diff === 1 && prev > 0) streak = loadNumber(LS.streak, 0) + 1;
      else if (prev > 0) streak = 1;
      else streak = 0;
      saveNumber(LS.streak, streak);
      todayScore = 0; saveNumber(LS.todayScore, 0);
      localStorage.removeItem(LS.taskDone);
      localStorage.setItem(LS.lastDate, todayKey);
    } else {
      streak = loadNumber(LS.streak, 0);
      todayScore = loadNumber(LS.todayScore, 0);
    }
    $("streak").textContent = streak;
    $("todayScore").textContent = todayScore;
  }

  // ========================= TOPICS =========================
  function populateTopics() {
    const container = $("topicPills");
    container.innerHTML = "";
    Object.keys(TOPICS).forEach((name, i) => {
      const pill = document.createElement("button");
      pill.className = "topic-pill" + (i === 0 ? " active" : "");
      pill.textContent = name;
      pill.onclick = () => {
        document.querySelectorAll('.topic-pill').forEach(p => p.classList.remove('active'));
        pill.classList.add('active');
        setTopic(name);
      };
      container.appendChild(pill);
    });
  }

  function setTopic(name) {
    currentTopicName = name;
    words = [...TOPICS[name]];
    idx = 0;
    renderCard();
    refreshChips();
  }

  // ========================= WORD CARD =========================
  function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

  function renderCard() {
    const item = words[idx % words.length];
    $("wordEn").textContent = capitalize(item.w);
    $("emojiFallback").textContent = item.e;

    const hints = [
      "Say: \"What is this?\"","Say: \"I want ...\"",
      "Say: \"This is big\"","Say: \"Where is ...?\"",
      "Say: \"I play with ...\""
    ];
    $("hint").textContent = hints[(idx + score) % hints.length];
    setWordImage(item);
  }

  function slugify(word) {
    return (word||"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");
  }

  function setWordImage(item) {
    const slug = slugify(item.w);
    const imgEl = $("wordImg"), fallback = $("emojiFallback");
    imgEl.style.display = "none"; fallback.style.display = "block";
    imgEl.onload = () => { imgEl.style.display = "block"; fallback.style.display = "none"; };
    imgEl.onerror = () => {
      imgEl.onerror = () => { imgEl.style.display="none"; fallback.style.display="block"; };
      imgEl.src = `images/${slug}.png`;
    };
    imgEl.src = `images/${slug}.jpg`;
  }

  function nextCard() { idx = (idx+1) % words.length; renderCard(); refreshChips(); }
  function shuffleWords() {
    for(let i=words.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[words[i],words[j]]=[words[j],words[i]];}
    idx=0; renderCard(); refreshChips();
  }

  // ========================= SENTENCE BUILDER =========================
  function renderSentence() {
    const box = $("sentenceBox");
    box.innerHTML = "";
    if (!sentence.length) {
      box.innerHTML = `<span class="sentence-empty">Tap the chips to make a sentence...</span>`;
      return;
    }
    sentence.forEach((t, i) => {
      const el = document.createElement("span");
      el.className = "token";
      el.textContent = t;
      el.title = "Tap to remove";
      el.onclick = () => { sentence.splice(i,1); renderSentence(); };
      box.appendChild(el);
    });
  }

  function setMode(m, tabEl) {
    currentMode = m;
    $("modeSelect").value = m;
    document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
    tabEl.classList.add('active');
    refreshChips();
  }

  function refreshChips() {
    const bank = SENTENCE_BANK[currentMode] || SENTENCE_BANK["mid"];
    const current = words[idx % words.length].w;
    let pool = [];
    Object.values(bank).forEach(arr => pool.push(...arr));
    pool.push(current, "this","is","a","the","big","small","very","I");
    pool = [...new Set(pool)];

    const chips = $("chips");
    chips.innerHTML = "";
    pool.forEach(t => {
      const c = document.createElement("div");
      c.className = "chip";
      c.textContent = t;
      c.onclick = () => {
        sentence.push(t); renderSentence();
        c.classList.add("on");
        setTimeout(() => c.classList.remove("on"), 200);
      };
      chips.appendChild(c);
    });

    const tpl = $("templates");
    tpl.innerHTML = "";
    TEMPLATES.forEach(t => {
      const c = document.createElement("div");
      c.className = "chip";
      c.textContent = t;
      c.onclick = () => {
        t.split(" ").filter(x => x !== "...").forEach(x => sentence.push(x));
        renderSentence();
        c.classList.add("on");
        setTimeout(() => c.classList.remove("on"), 200);
      };
      tpl.appendChild(c);
    });
  }

  // ========================= TASKS =========================
  function pickTask() {
    const key = localStorage.getItem(LS.lastDate) || ymd(new Date());
    let h = 0;
    for(let i=0;i<key.length;i++) h=(h*31+key.charCodeAt(i))>>>0;
    const t = DAILY_TASKS[h % DAILY_TASKS.length];
    localStorage.setItem(LS.task, JSON.stringify(t));
    return t;
  }
  function getTask() { try { return JSON.parse(localStorage.getItem(LS.task)||"null"); } catch(e){ return null; } }

  function renderTask(t) {
    $("taskTitle").textContent = t.title;
    $("taskDesc").textContent = t.desc;
    $("taskGoal").textContent = t.goal;
    const done = loadNumber(LS.taskDone, 0);
    $("taskDone").textContent = done;
    $("taskBar").style.width = Math.min(100, Math.round(done/t.goal*100)) + "%";
  }
  function loadTask() { let t = getTask(); if (!t) t = pickTask(); renderTask(t); }

  function updateTaskProgress(kind, amount=1) {
    const t = getTask(); if (!t) return;
    const done = loadNumber(LS.taskDone, 0);
    if (t.kind === kind) {
      const newDone = Math.min(t.goal, done + amount);
      saveNumber(LS.taskDone, newDone);
      $("taskDone").textContent = newDone;
      $("taskBar").style.width = Math.round(newDone/t.goal*100) + "%";
    }
  }

  function claimTask() {
    const t = getTask(); if (!t) return;
    const done = loadNumber(LS.taskDone, 0);
    if (done < t.goal) { alert("The task is not finished yet üôÇ"); return; }
    const rk = "juren_claimed_"+(localStorage.getItem(LS.lastDate)||ymd(new Date()));
    if (localStorage.getItem(rk)==="1") { alert("Today's reward has already been claimed ‚úÖ"); return; }
    localStorage.setItem(rk,"1");
    addScore(15);
    speak("Wonderful job Jurabek! Today's task is done!");
    confetti();
    alert("üéâ Amazing! +15 points added!");
  }

  function renderAllTasks() {
    const container = $("allTasks");
    container.innerHTML = "";
    DAILY_TASKS.forEach(t => {
      const div = document.createElement("div");
      div.style.cssText = "display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:2px dashed #EEE;";
      div.innerHTML = `<span style="font-size:20px;">üéØ</span>
        <div><div style="font-weight:800;">${t.title}</div>
        <div style="font-size:12px;color:var(--muted);font-weight:700;">${t.desc}</div></div>`;
      container.appendChild(div);
    });
  }

  // ========================= REWARDS =========================
  function updateRewardPage() {
    $("rewardScore").textContent = score;
    $("badgeDisplay").textContent = localStorage.getItem(LS.badge) || "Beginner";
    const thresholds = {
      "badge-beginner":0,"badge-brave":50,"badge-star":120,
      "badge-champion":220,"badge-super":400,"badge-legend":700
    };
    Object.entries(thresholds).forEach(([id, req]) => {
      const el = $(id);
      if (el) el.classList.toggle('unlocked', score >= req);
    });
  }

  // ========================= WIRE EVENTS =========================
  $("nextBtn").onclick = nextCard;
  $("shuffleBtn").onclick = shuffleWords;
  $("sayBtn").onclick = () => speak(words[idx % words.length].w);
  $("micBtn").onclick = () => startMicCheck(() => words[idx % words.length].w);
  $("saidBtn").onclick = () => {
    addScore(2);
    updateTaskProgress("said", 1);
    if (currentTopicName.startsWith("Body")) updateTaskProgress("bodyWords", 1);
    if (currentTopicName.startsWith("Food")) updateTaskProgress("foodWords", 1);
    nextCard();
  };
  $("repeatBtn").onclick = () => {
    addScore(1);
    const item = words[idx % words.length];
    speak(`This is ${item.w}. I say ${item.w}.`);
  };
  $("modeSelect").onchange = (e) => { currentMode = e.target.value; refreshChips(); };

  $("clearSentenceBtn").onclick = () => { sentence = []; renderSentence(); };
  $("saySentenceBtn").onclick = () => {
    const t = sentence.join(" ").trim();
    if (!t) { alert("No sentence yet üôÇ"); return; }
    speak(t);
  };
  $("doneSentenceBtn").onclick = () => {
    const t = sentence.join(" ").trim();
    if (!t) { alert("Make a sentence first üôÇ"); return; }
    const pts = Math.min(10, Math.max(3, sentence.length));
    addScore(pts); speak(t); confetti();
    updateTaskProgress("sent", 1);
    const lower = t.toLowerCase();
    if (lower.startsWith("i ")) updateTaskProgress("iSent", 1);
    setTimeout(() => { sentence = []; renderSentence(); }, 1000);
  };

  $("claimBtn").onclick = claimTask;
  $("newTaskBtn").onclick = () => {
    const t = DAILY_TASKS[Math.floor(Math.random()*DAILY_TASKS.length)];
    localStorage.setItem(LS.task, JSON.stringify(t));
    saveNumber(LS.taskDone, 0);
    renderTask(t);
  };
  $("resetBtn").onclick = () => {
    if (!confirm("Reset all points and progress?")) return;
    Object.values(LS).forEach(k => localStorage.removeItem(k));
    location.reload();
  };

  // ========================= INIT =========================

  // ---- Inject Web App Manifest (Android PWA) ----
  (function injectManifest() {
    const iconSvg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' rx='80' fill='%23FF9A3C'/><text y='360' x='256' font-size='320' text-anchor='middle'>üé§</text></svg>`;
    const icon192 = 'data:image/svg+xml,' + iconSvg;
    const manifest = {
      name: "Jurabek Speech Game",
      short_name: "Speech Game",
      description: "Fun speech therapy game for kids!",
      start_url: "./",
      display: "standalone",
      orientation: "portrait",
      background_color: "#FFF8F0",
      theme_color: "#FF9A3C",
      icons: [
        { src: icon192, sizes: "192x192", type: "image/svg+xml" },
        { src: icon192, sizes: "512x512", type: "image/svg+xml", purpose: "any maskable" }
      ]
    };
    const blob = new Blob([JSON.stringify(manifest)], { type: "application/json" });
    const url  = URL.createObjectURL(blob);
    const link = document.createElement("link");
    link.rel = "manifest"; link.href = url;
    document.head.appendChild(link);
  })();

  // ---- Service Worker (offline support) ----
  if ("serviceWorker" in navigator) {
    const swCode = `
      self.addEventListener('install', e => self.skipWaiting());
      self.addEventListener('activate', e => clients.claim());
      self.addEventListener('fetch', e => {
        if (e.request.method !== 'GET') return;
        e.respondWith(
          caches.open('speech-game-v1').then(cache =>
            fetch(e.request).then(res => { cache.put(e.request, res.clone()); return res; })
            .catch(() => caches.match(e.request))
          )
        );
      });
    `;
    const swBlob = new Blob([swCode], { type: "application/javascript" });
    const swUrl  = URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swUrl).catch(() => {});
  }

  // ---- Install Prompt (Android Chrome / Samsung Internet) ----
  let deferredPrompt = null;

  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;
    const dismissed = localStorage.getItem("banner_dismissed");
    if (dismissed) return;
    showAndroidBanner();
  });

  function showAndroidBanner() {
    const banner  = $("installBanner");
    const content = $("bannerContent");
    const btn     = $("androidInstallBtn");
    if (!banner) return;
    content.innerHTML = `üì≤ <strong>Install the App!</strong><br>
      <span style="font-size:12px;font-weight:700;opacity:.9;">Use like a real app ‚Äî fast &amp; offline!</span>`;
    btn.style.display = "inline-block";
    btn.onclick = async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === "accepted") dismissBanner();
      deferredPrompt = null;
    };
    banner.style.display = "block";
  }

  function showIOSBanner() {
    const banner  = $("installBanner");
    const content = $("bannerContent");
    const btn     = $("androidInstallBtn");
    if (!banner) return;
    content.innerHTML = `üì± <strong>Add to Home Screen!</strong><br>
      <span style="font-size:12px;font-weight:700;opacity:.9;">
        Tap <strong>Share ‚Üë</strong> ‚Üí <strong>"Add to Home Screen"</strong>
      </span>`;
    if (btn) btn.style.display = "none";
    banner.style.display = "block";
  }

  function dismissBanner() {
    const banner = $("installBanner");
    if (banner) banner.style.display = "none";
    localStorage.setItem("banner_dismissed", "1");
  }

  window.addEventListener("appinstalled", () => {
    dismissBanner();
    deferredPrompt = null;
  });

  // ========================= MAIN INIT =========================
  (function init() {
    dailyCheck();
    score = loadNumber(LS.score, 0);
    $("score").textContent = score;
    $("badge").textContent = localStorage.getItem(LS.badge) || "Beginner";
    setBadge();
    updateStars();
    populateTopics();
    setTopic(currentTopicName);
    renderSentence();
    refreshChips();
    loadTask();

    const av = $("avatarImg");
    av.onerror = () => { av.style.display = "none"; };
    av.onload  = () => { $("avatarEmoji") && ($("avatarEmoji").style.display = "none"); };

    // iOS: show manual install banner after 3s
    const isIOS        = /iphone|ipad|ipod/i.test(navigator.userAgent);
    const isStandalone = window.navigator.standalone === true ||
                         window.matchMedia("(display-mode: standalone)").matches;
    const dismissed    = localStorage.getItem("banner_dismissed");

    if (!isStandalone && !dismissed) {
      if (isIOS) {
        setTimeout(showIOSBanner, 3000);
      }
      // Android banner is shown automatically via beforeinstallprompt above
    }

    // iOS Safari: warm up TTS on first touch
    document.body.addEventListener("touchstart", () => { ensureTTS(); }, { once: true, passive: true });
  })();
</script>
</body>
</html>
